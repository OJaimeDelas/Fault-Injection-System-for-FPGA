# Area Profiles

Area profiles define **which targets** to inject during a fault injection campaign. They are responsible for building a `TargetPool` containing an ordered sequence of injection targets.

## Overview

Area profiles control:
- **Target selection**: Which modules, registers, or configuration bits to target
- **Pool size**: How many targets to include
- **Target order**: The sequence in which targets are injected
- **Filtering**: Which targets to include or exclude based on criteria

Area profiles do NOT control:
- **When injections happen**: That's the responsibility of time profiles
- **How targets are injected**: That's handled by the injection controller and backends

## Available Profiles

### `device`
Targets the entire FPGA device indiscriminately.

**Usage:**
```bash
python3 -m fi.fault_injection --area device
```

**Arguments:**
- `pool_size`: Number of targets to generate (default: 1000)
- `ratio`: Fraction of REG targets vs CONFIG targets, 0.0-1.0 (default: 0.0, all CONFIG)

**Example:**
```bash
# 500 targets, 30% registers, 70% configuration bits
python3 -m fi.fault_injection \
    --area device \
    --area-args "pool_size=500,ratio=0.3"
```

### `modules`
Targets specific modules by name.

**Usage:**
```bash
python3 -m fi.fault_injection \
    --area modules \
    --area-args "pool_size=100,ratio=0.5"
```

**Arguments:**
- `pool_size`: Total number of targets (default: 1000)
- `ratio`: Fraction of REG targets (default: 0.0)
- `modules`: Comma-separated module names (default: all modules)

**Example:**
```bash
# Target only ALU and LSU modules
python3 -m fi.fault_injection \
    --area modules \
    --area-args "pool_size=200,modules=alu,lsu"
```

### `target_list`
Load explicit target list from YAML file.

**Usage:**
```bash
python3 -m fi.fault_injection \
    --area target_list \
    --area-args "pool_file=/path/to/targets.yaml"
```

**Arguments:**
- `pool_file`: Path to YAML file with target list (required)

**YAML Format:**
```yaml
targets:
  - kind: CONFIG
    module_name: "ibex_controller"
    config_address: "12345678"
    pblock_name: "controller_region"
  
  - kind: REG
    module_name: "ibex_controller"
    reg_id: 7
    reg_name: "pc"
```

### `input`
Load external custom area profile from a Python module.

**Usage:**
```bash
python3 -m fi.fault_injection \
    --area input \
    --area-args "module_path=/path/to/custom_profile.py"
```

**Arguments:**
- `module_path`: Path to external .py file implementing area profile interface (required)
- Additional arguments are passed through to the external profile

## Creating Custom Profiles

### Option 1: Add to fi/profiles/area/

Create a new Python file in `fi/profiles/area/` following the standard interface:
```python
# fi/profiles/area/my_profile.py

PROFILE_KIND = "area"
PROFILE_NAME = "my_profile"

def describe():
    return "My custom area profile"

def default_args():
    return {
        "my_param": 42
    }

def make_profile(args, *, global_seed, settings):
    from fi.profiles.area.base import AreaProfileBase
    
    class MyProfile(AreaProfileBase):
        def build_pool(self, system_dict, board_name, ebd_path):
            from fi.targets.pool import TargetPool
            pool = TargetPool()
            # Your target selection logic here
            return pool
    
    return MyProfile(PROFILE_NAME, args, global_seed)
```

### Option 2: Use External Profile with `input`

Create a Python file anywhere in your file system:
```python
# /home/user/my_custom_area.py

PROFILE_KIND = "area"
PROFILE_NAME = "my_custom"

def describe():
    return "My custom area profile"

def default_args():
    return {
        "my_param": 42,
        "filter_pattern": "alu*"
    }

def make_profile(args, *, global_seed, settings):
    from fi.profiles.area.base import AreaProfileBase
    from fi.targets.pool import TargetPool
    from fi.targets.types import TargetSpec, TargetKind
    
    class MyCustomProfile(AreaProfileBase):
        def __init__(self, name, args, seed):
            super().__init__(name, args, seed)
            self.my_param = int(args.get("my_param", 42))
            self.filter_pattern = args.get("filter_pattern", "*")
        
        def build_pool(self, system_dict, board_name, ebd_path):
            pool = TargetPool()
            
            # Your custom target selection logic
            # Access system_dict, use self.my_param, etc.
            
            return pool
    
    return MyCustomProfile("my_custom", args, global_seed)
```

**Usage:**
```bash
python3 -m fi.fault_injection \
    --area input \
    --area-args "module_path=/home/user/my_custom_area.py,my_param=100,filter_pattern=lsu*"
```

**Interface Requirements:**

External profiles must define:
- `PROFILE_KIND = "area"` (constant)
- `PROFILE_NAME` (string constant)
- `describe()` - return description string
- `default_args()` - return dict of default arguments
- `make_profile(args, *, global_seed, settings)` - return profile object

The profile object returned by `make_profile()` must have:
- `build_pool(system_dict, board_name, ebd_path)` method that returns a `TargetPool`

**Validation:**

The `input` profile validates external modules to ensure they implement the required interface. Clear error messages are provided if validation fails.

## Profile Development Tips

1. **Inherit from AreaProfileBase**: Provides common functionality and name tracking
2. **Use TargetPool.add()**: Add targets one at a time in injection order
3. **Respect pool_size**: Honor the requested pool size from arguments
4. **Document arguments**: Provide clear default_args() and document behavior
5. **Handle missing data**: Gracefully handle cases where modules/registers don't exist
6. **Use ACME for CONFIG**: Use ACME to map pblock regions to configuration addresses
7. **Validate inputs**: Check argument types and ranges early

## Argument Parsing

Area profile arguments are passed as a comma-separated string via `--area-args`:
```bash
--area-args "key1=value1,key2=value2,key3=value3"
```

The loader parses this into a dictionary:
```python
{
    "key1": "value1",
    "key2": "value2", 
    "key3": "value3"
}
```

All values are strings initially. Profiles should convert to appropriate types:
```python
pool_size = int(args.get("pool_size", 1000))
ratio = float(args.get("ratio", 0.0))
enabled = args.get("enabled", "true").lower() == "true"
```

## Related Documentation

### Core Systems
- [Main README](../../Readme.md) - System overview, area profile section
- [Config System](../../core/config/Readme.md) - Seed management for reproducibility
- [Campaign Controller](../../core/campaign/Readme.md) - Uses pools from area profiles

### Profiles
- [Profile Overview](../Readme.md) - Area and time profile system
- [Time Profiles](../time/Readme) - Campaign scheduling (pairs with area)

### Targets
- [Target System](../../targets/Readme.md) - TargetSpec and TargetPool

### Backends
- [Backend Overview](../../backend/Readme.md) - Where targets are sent
- [ACME Backend](../../backend/acme/Readme.md) - Address expansion for device/modules

### See Also
- `fi_settings.py` - TPOOL_DEFAULT_SIZE and area profile defaults
- `base.py` - AreaProfileBase abstract class
- `common/loader.py` - Dynamic profile loading
- Target pool export in main README
- System dictionary format (main README, lines 150-233)